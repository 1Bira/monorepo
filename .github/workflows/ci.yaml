on:
  workflow_dispatch:
  push:
    branches:
    - main
    paths:
      - 'apps/app1/**' # Só dispara se houver mudanças aqui

jobs:
  detect-changes:
    name: "Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      run_build: ${{ steps.set-matrix.outputs.run_build }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessário para o git diff funcionar corretamente

      - name: Detect Changed Files
        id: set-matrix
        run: |
          # Detecta arquivos alterados entre a branch atual e a base
          DIFF=$(git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD)
          
          echo "Arquivos alterados: $DIFF"

          # Verifica se houve mudanças no código compartilhado
          SHARED_CHANGES=$(echo "$DIFF" | grep -E '^(shared/|tooling/|shared-svc/)' || true)
          
          if [ ! -z "$SHARED_CHANGES" ]; then
            echo "Mudança em código compartilhado detectada. Selecionando todas as funções."
            # Busca todas as pastas dentro de packages/functions
            FUNCTIONS=$(ls -d packages/functions/* | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "matrix=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "run_build=true" >> $GITHUB_OUTPUT
          else
            # Busca apenas as funções específicas que mudaram
            FUNCTIONS=$(echo "$DIFF" | grep '^packages/functions/' | cut -d'/' -f1-3 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            
            if [ "$FUNCTIONS" != "[]" ]; then
              echo "Mudanças detectadas em funções específicas: $FUNCTIONS"
              echo "matrix=$FUNCTIONS" >> $GITHUB_OUTPUT
              echo "run_build=true" >> $GITHUB_OUTPUT
            else
              echo "Nenhuma mudança relevante detectada."
              echo "run_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    needs: detect-changes
    if: needs: detect-changes.outputs.run_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        function_path: ${{(needs.detect-changes.outputs.matrix)}}
      fail-fast: false # Não cancela outras funções se uma falhar
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.function_path }}/package-lock.json'

      - name: Install Dependencies
        run: npm ci
        working-directory: ${{ matrix.function_path }}

      - name: Build Function App
        run: npm run build --if-present
        working-directory: ${{ matrix.function_path }}
      
